<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #d0d0d0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .user-count {
            font-size: 14px;
            color: #666;
            background: rgba(33, 150, 243, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        .add-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .add-button:hover {
            background: #1976D2;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }

        .message.own .message-content {
            align-items: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .message.own .message-header {
            flex-direction: row-reverse;
        }

        .message-username {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .message-time {
            font-size: 11px;
            color: #999;
        }

        .message-text {
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: inline-block;
            width: fit-content;
            max-width: 100%;
            white-space: pre-wrap;
        }

        .message.own .message-text {
            background: #2196F3;
            color: white;
        }

        .input-container {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-top: 1px solid #d0d0d0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message-input {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            resize: none;
            height: 80px;
            font-family: inherit;
            overflow-y: auto;
            box-sizing: border-box;
            background: transparent;
            word-wrap: break-word;
            line-height: 1.4;
            color: #333;
        }

        .message-input::-webkit-resizer {
            display: none;
        }

        .message-input::placeholder {
            color: #666;
        }

        /* è¾“å…¥æ¡†æ»šåŠ¨æ¡æ ·å¼ */
        .message-input::-webkit-scrollbar {
            width: 6px;
        }

        .message-input::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .message-input::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .message-input::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .button-container {
            display: flex;
            justify-content: flex-end;
        }

        .send-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            height: 40px;
            transition: background-color 0.2s;
        }

        .send-button:hover {
            background: #1976D2;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }

        .error {
            text-align: center;
            color: #f44336;
            padding: 20px;
            font-size: 14px;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .messages-container::-webkit-scrollbar {
            width: 4px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 600px) {
            .header {
                padding: 10px 15px;
            }
            
            .header-left {
                gap: 8px;
            }
            
            .title {
                font-size: 15px;
            }
            
            .user-count {
                font-size: 13px;
                padding: 3px 6px;
            }
            
            .add-button {
                width: 28px;
                height: 28px;
                font-size: 16px;
            }
            
            .messages-container {
                padding: 10px;
            }
            
            .input-container {
                padding: 12px;
                gap: 8px;
            }
            
            .message-input {
                height: 70px;
                padding: 10px 12px;
            }
            
            .send-button {
                padding: 8px 20px;
                height: 36px;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="title">èŠå¤©å®¤</div>
            <div class="user-count" id="userCount">è¿æ¥ä¸­...</div>
        </div>
        <div class="header-right">
            <button class="add-button" onclick="window.open('http://quruanpu.cccpan.com/', '_blank')">+</button>
        </div>
    </div>

    <div class="messages-container" id="messagesContainer">
        <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
    </div>

    <div class="input-container">
        <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="3"></textarea>
        <div class="button-container">
            <button class="send-button" id="sendButton" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDf8kj-hckk2GYDVCRtJYGPzAXtvEyuOYA",
            authDomain: "liaotian-6afd4.firebaseapp.com",
            databaseURL: "https://liaotian-6afd4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "liaotian-6afd4",
            storageBucket: "liaotian-6afd4.firebasestorage.app",
            messagingSenderId: "724719798609",
            appId: "1:724719798609:web:be52644226210a50cfab70",
            measurementId: "G-N5WK9GVEHE"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ç”Ÿæˆç”¨æˆ·ID
        function generateUserId() {
            const randomNum = Math.floor(Math.random() * 10000);
            return `user_${Date.now()}_${randomNum}`;
        }

        // ç”Ÿæˆéšæœºç”¨æˆ·ä¿¡æ¯
        function generateRandomUserInfo() {
            const avatars = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ™', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ˜', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸ¦Œ', 'ğŸ•', 'ğŸˆ', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ‡', 'ğŸ', 'ğŸ€', 'ğŸ¿ï¸', 'ğŸ¦”'];
            const adjectives = ['å¿«ä¹', 'èªæ˜', 'å‹‡æ•¢', 'æ¸©æŸ”', 'æ´»æ³¼', 'ç¥ç§˜', 'å¯çˆ±', 'å‹å–„', 'å†·é™', 'çƒ­æƒ…', 'å¹½é»˜', 'ä¼˜é›…', 'åšå¼º', 'å–„è‰¯', 'æœºæ™º', 'æ·˜æ°”', 'æ¸©æš–', 'å¼€æœ—', 'å®‰é™', 'è‡ªä¿¡'];
            const nouns = ['ç†ŠçŒ«', 'ä¼é¹…', 'æµ·è±š', 'å°é¸Ÿ', 'è´è¶', 'å°çŒ«', 'å°ç‹—', 'å…”å­', 'æ¾é¼ ', 'è€ƒæ‹‰', 'ç‹ç‹¸', 'å°ç¾Š', 'å°é¹¿', 'æµ·æ˜Ÿ', 'èœœèœ‚', 'å°é±¼', 'å°è±¡', 'é•¿é¢ˆé¹¿', 'å°é©¬', 'å°ç†Š'];
            
            const avatar = avatars[Math.floor(Math.random() * avatars.length)];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            
            return {
                avatar: avatar,
                username: adjective + noun,
                color: `hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`
            };
        }

        // ä»localStorageè·å–æˆ–åˆ›å»ºç”¨æˆ·ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function getOrCreateUser() {
            const STORAGE_KEY = 'chatroom_user_info';
            
            try {
                // å°è¯•ä»localStorageè·å–å·²ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯
                const savedUser = localStorage.getItem(STORAGE_KEY);
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    // éªŒè¯ç”¨æˆ·ä¿¡æ¯å®Œæ•´æ€§
                    if (user.id && user.username && user.avatar && user.color) {
                        console.log('ä½¿ç”¨å·²ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯:', user.username);
                        return user;
                    }
                }
            } catch (error) {
                console.log('è¯»å–å·²ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ç”¨æˆ·');
            }
            
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯æˆ–ä¿¡æ¯ä¸å®Œæ•´ï¼Œåˆ™ç”Ÿæˆæ–°ç”¨æˆ·
            const newUserInfo = generateRandomUserInfo();
            const newUser = {
                id: generateUserId(),
                username: newUserInfo.username,
                avatar: newUserInfo.avatar,
                color: newUserInfo.color
            };
            
            // ä¿å­˜æ–°ç”¨æˆ·ä¿¡æ¯åˆ°localStorage
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newUser));
                console.log('æ–°ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜:', newUser.username);
            } catch (error) {
                console.log('ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
            
            return newUser;
        }

        // å…¨å±€å˜é‡
        let currentUser = getOrCreateUser();
        let messagesRef = database.ref('messages');
        let onlineUsersRef = database.ref('onlineUsers');
        let messageInput, messagesContainer, sendButton;

        // æ¶ˆæ¯å‘é€é¢‘ç‡é™åˆ¶ç›¸å…³
        let userMessageTimes = [];
        const MESSAGE_LIMIT = 10;
        const TIME_WINDOW = 60000;

        // æ‡’åŠ è½½ç›¸å…³ - ä¿®æ”¹ä¸ºSetæ¥å­˜å‚¨å·²åŠ è½½çš„æ¶ˆæ¯keyï¼Œé¿å…é‡å¤
        let loadedMessageKeys = new Set();
        let lastMessageKey = null;
        let isLoadingMore = false;
        let hasMoreMessages = true;
        let isInitialLoad = true;
        const MESSAGES_PER_LOAD = 20;

        // æ£€æŸ¥å‘é€é¢‘ç‡é™åˆ¶
        function checkSendLimit() {
            const now = Date.now();
            
            // æ¸…é™¤è¶…è¿‡æ—¶é—´çª—å£çš„è®°å½•
            userMessageTimes = userMessageTimes.filter(time => now - time < TIME_WINDOW);
            
            // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
            if (userMessageTimes.length >= MESSAGE_LIMIT) {
                const oldestTime = Math.min(...userMessageTimes);
                const waitTime = Math.ceil((TIME_WINDOW - (now - oldestTime)) / 1000);
                
                showTemporaryMessage(`å‘é€å¤ªé¢‘ç¹ï¼Œè¯·ç­‰å¾… ${waitTime} ç§’åå†å‘é€`, 'warning');
                return false;
            }
            
            return true;
        }

        // æ˜¾ç¤ºä¸´æ—¶æç¤ºæ¶ˆæ¯
        function showTemporaryMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `temporary-message ${type}`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                z-index: 1000;
                font-size: 14px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'åˆšåˆš';
            if (diffMins <= 10) return `${diffMins}åˆ†é’Ÿå‰`;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const messageDate = new Date(date);
            messageDate.setHours(0, 0, 0, 0);
            
            if (messageDate.getTime() === today.getTime()) {
                return date.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            return date.toLocaleString('zh-CN', { 
                month: 'numeric', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            });
        }

        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.dataset.timestamp = message.timestamp;
            
            // å¦‚æœæ¶ˆæ¯æœ‰keyï¼Œæ·»åŠ åˆ°datasetä¸­
            if (message.key) {
                messageDiv.setAttribute('data-message-key', message.key);
            }
            
            if (message.userId === currentUser.id) {
                messageDiv.classList.add('own');
            }
            
            const timeText = formatTime(message.timestamp);
            
            messageDiv.innerHTML = `
                <div class="message-avatar" style="background-color: ${message.userColor}">${message.userAvatar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <div class="message-username">${message.username}</div>
                        <div class="message-time">${timeText}</div>
                    </div>
                    <div class="message-text">${escapeHtml(message.text)}</div>
                </div>
            `;
            
            return messageDiv;
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ›´æ–°æ‰€æœ‰æ¶ˆæ¯çš„æ—¶é—´æ˜¾ç¤º
        function updateMessageTimes() {
            const messages = messagesContainer.querySelectorAll('.message');
            messages.forEach(messageElement => {
                const timeElement = messageElement.querySelector('.message-time');
                const timestamp = messageElement.dataset.timestamp;
                if (timestamp && timeElement) {
                    const newTimeText = formatTime(parseInt(timestamp));
                    timeElement.textContent = newTimeText;
                }
            });
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            if (!currentUser) {
                console.log('ç”¨æˆ·ä¿¡æ¯å°šæœªåŠ è½½å®Œæˆ');
                return;
            }
            
            const text = messageInput.value.trim();
            if (!text || text.length === 0) return;

            // æ£€æŸ¥å‘é€é¢‘ç‡é™åˆ¶
            if (!checkSendLimit()) {
                return;
            }

            const message = {
                text: text,
                username: currentUser.username,
                userAvatar: currentUser.avatar,
                userColor: currentUser.color,
                userId: currentUser.id,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            messagesRef.push(message)
                .then(() => {
                    messageInput.value = '';
                    messageInput.focus();
                    // è®°å½•å‘é€æ—¶é—´
                    userMessageTimes.push(Date.now());
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateSendButtonStatus();
                })
                .catch((error) => {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    if (error.code === 'PERMISSION_DENIED') {
                        showError('æ•°æ®åº“æƒé™æœªè®¾ç½®ï¼Œè¯·æ£€æŸ¥Firebaseå®‰å…¨è§„åˆ™');
                    }
                });
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            messagesContainer.innerHTML = `
                <div class="error">
                    <div>âš ï¸ ${message}</div>
                    <div style="margin-top: 10px; font-size: 12px;">è¯·åœ¨Firebaseæ§åˆ¶å°è®¾ç½®å®‰å…¨è§„åˆ™</div>
                </div>
            `;
        }

        // æ³¨å†Œåœ¨çº¿ç”¨æˆ·
        function registerOnlineUser() {
            if (!currentUser) return;
            
            const userRef = onlineUsersRef.child(currentUser.id);
            userRef.set({
                username: currentUser.username,
                avatar: currentUser.avatar,
                color: currentUser.color,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            }).catch((error) => {
                console.error('æ³¨å†Œåœ¨çº¿ç”¨æˆ·å¤±è´¥:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    showError('æ•°æ®åº“æƒé™æœªè®¾ç½®ï¼Œè¯·æ£€æŸ¥Firebaseå®‰å…¨è§„åˆ™');
                }
            });

            userRef.onDisconnect().remove();
        }

        // ä¿®å¤åçš„åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯å‡½æ•°
        function loadMoreMessages() {
            if (isLoadingMore || !hasMoreMessages) return;
            
            isLoadingMore = true;
            showLoadingIndicator();
            
            let query;
            if (lastMessageKey) {
                // åŠ è½½æŒ‡å®šæ¶ˆæ¯ä¹‹å‰çš„æ¶ˆæ¯
                query = messagesRef.orderByKey().endBefore(lastMessageKey).limitToLast(MESSAGES_PER_LOAD);
            } else {
                // é¦–æ¬¡åŠ è½½æœ€æ–°æ¶ˆæ¯
                query = messagesRef.orderByKey().limitToLast(MESSAGES_PER_LOAD);
            }
            
            query.once('value', function(snapshot) {
                const messages = [];
                snapshot.forEach(function(childSnapshot) {
                    const messageKey = childSnapshot.key;
                    const message = childSnapshot.val();
                    
                    // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½è¿‡è¿™æ¡æ¶ˆæ¯ï¼Œé¿å…é‡å¤
                    if (message && !loadedMessageKeys.has(messageKey)) {
                        message.key = messageKey;
                        messages.unshift(message); // æ’å…¥åˆ°æ•°ç»„å¼€å¤´ï¼Œä¿æŒæ—¶é—´é¡ºåº
                        loadedMessageKeys.add(messageKey); // è®°å½•å·²åŠ è½½çš„æ¶ˆæ¯
                    }
                });
                
                // å¦‚æœæ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œè¯´æ˜å·²ç»åŠ è½½å®Œæ‰€æœ‰å†å²æ¶ˆæ¯
                if (messages.length === 0) {
                    hasMoreMessages = false;
                    hideLoadingIndicator();
                    isLoadingMore = false;
                    console.log('æ²¡æœ‰æ›´å¤šå†å²æ¶ˆæ¯');
                    return;
                }
                
                // æ›´æ–°æœ€æ—©æ¶ˆæ¯çš„key
                if (messages.length > 0) {
                    lastMessageKey = messages[0].key;
                }
                
                // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                const oldScrollHeight = messagesContainer.scrollHeight;
                const oldScrollTop = messagesContainer.scrollTop;
                
                // å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°å®¹å™¨é¡¶éƒ¨
                messages.forEach(message => {
                    const messageElement = createMessageElement(message);
                    messagesContainer.insertBefore(messageElement, messagesContainer.firstChild);
                });
                
                // è°ƒæ•´æ»šåŠ¨ä½ç½®ï¼Œä¿æŒç”¨æˆ·å½“å‰æŸ¥çœ‹çš„å†…å®¹ä¸å˜
                if (isInitialLoad) {
                    // é¦–æ¬¡åŠ è½½ï¼Œæ»šåŠ¨åˆ°åº•éƒ¨
                    scrollToBottom();
                    isInitialLoad = false;
                } else {
                    // åç»­åŠ è½½ï¼Œä¿æŒæ»šåŠ¨ä½ç½®
                    const newScrollHeight = messagesContainer.scrollHeight;
                    messagesContainer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
                }
                
                hideLoadingIndicator();
                isLoadingMore = false;
                
                // ä¿®å¤åˆ¤æ–­é€»è¾‘ï¼šå¦‚æœè¿™æ¬¡è·å–åˆ°çš„æ¶ˆæ¯æ•°é‡å°‘äºè¯·æ±‚æ•°é‡ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†
                if (messages.length < MESSAGES_PER_LOAD) {
                    hasMoreMessages = false;
                    console.log('å·²åŠ è½½æ‰€æœ‰å†å²æ¶ˆæ¯');
                }
            }, function(error) {
                console.error('åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:', error);
                hideLoadingIndicator();
                isLoadingMore = false;
            });
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoadingIndicator() {
            let indicator = document.getElementById('loadingIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loadingIndicator';
                indicator.className = 'loading-indicator';
                indicator.style.cssText = `
                    text-align: center;
                    color: #666;
                    padding: 10px;
                    font-size: 12px;
                    background: rgba(255,255,255,0.8);
                    margin-bottom: 10px;
                `;
                indicator.textContent = 'æ­£åœ¨åŠ è½½å†å²æ¶ˆæ¯...';
                messagesContainer.insertBefore(indicator, messagesContainer.firstChild);
            }
        }

        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }

        // ä¿®å¤åçš„ç›‘å¬æ–°æ¶ˆæ¯å‡½æ•° - åªç›‘å¬æ–°æ¶ˆæ¯ï¼Œä¸å¤„ç†å†å²æ¶ˆæ¯
        function listenForNewMessages() {
            // åªç›‘å¬æ–°æ·»åŠ çš„æ¶ˆæ¯ï¼Œé¿å…é‡å¤åŠ è½½
            messagesRef.on('child_added', function(snapshot) {
                const messageKey = snapshot.key;
                const message = snapshot.val();
                
                // å¦‚æœè¿™æ¡æ¶ˆæ¯è¿˜æ²¡æœ‰è¢«åŠ è½½è¿‡ï¼Œä¸”ä¸æ˜¯åˆå§‹åŠ è½½æœŸé—´ï¼Œåˆ™æ·»åŠ åˆ°ç•Œé¢
                if (message && currentUser && !loadedMessageKeys.has(messageKey) && !isInitialLoad) {
                    message.key = messageKey;
                    loadedMessageKeys.add(messageKey);
                    
                    if (messagesContainer.querySelector('.loading')) {
                        messagesContainer.innerHTML = '';
                    }
                    
                    const messageElement = createMessageElement(message);
                    messagesContainer.appendChild(messageElement);
                    scrollToBottom();
                }
            }, function(error) {
                console.error('ç›‘å¬æ¶ˆæ¯å¤±è´¥:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    showError('æ•°æ®åº“æƒé™æœªè®¾ç½®ï¼Œè¯·æ£€æŸ¥Firebaseå®‰å…¨è§„åˆ™');
                }
            });
        }

        // ç›‘å¬åœ¨çº¿ç”¨æˆ·æ•°é‡
        function listenForOnlineUsers() {
            onlineUsersRef.on('value', function(snapshot) {
                const onlineUsers = snapshot.val() || {};
                const count = Object.keys(onlineUsers).length;
                document.getElementById('userCount').textContent = `${count}äººåœ¨çº¿`;
            }, function(error) {
                console.error('ç›‘å¬åœ¨çº¿ç”¨æˆ·å¤±è´¥:', error);
                document.getElementById('userCount').textContent = 'è¿æ¥é”™è¯¯';
            });
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€å’Œå‰©ä½™æ¬¡æ•°æ˜¾ç¤º
        function updateSendButtonStatus() {
            const now = Date.now();
            userMessageTimes = userMessageTimes.filter(time => now - time < TIME_WINDOW);
            
            const remainingMessages = MESSAGE_LIMIT - userMessageTimes.length;
            
            if (remainingMessages <= 0) {
                sendButton.disabled = true;
                sendButton.textContent = 'å‘é€å—é™';
                const oldestTime = Math.min(...userMessageTimes);
                const waitTime = Math.ceil((TIME_WINDOW - (now - oldestTime)) / 1000);
                sendButton.title = `å‘é€å¤ªé¢‘ç¹ï¼Œè¯·ç­‰å¾… ${waitTime} ç§’`;
            } else {
                sendButton.disabled = false;
                sendButton.textContent = 'å‘é€';
                sendButton.title = `å‰©ä½™ ${remainingMessages}/${MESSAGE_LIMIT} æ¡æ¶ˆæ¯`;
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // é”®ç›˜äº‹ä»¶
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
            messageInput.addEventListener('input', updateSendButtonStatus);
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            // ç¡®ä¿DOMå…ƒç´ éƒ½å·²åŠ è½½
            messagesContainer = document.getElementById('messagesContainer');
            messageInput = document.getElementById('messageInput');
            sendButton = document.getElementById('sendButton');
            
            if (!messagesContainer || !messageInput || !sendButton) {
                console.error('æ— æ³•æ‰¾åˆ°å¿…è¦çš„DOMå…ƒç´ ');
                return;
            }
            
            messagesContainer.innerHTML = '<div class="loading">æ­£åœ¨è¿æ¥èŠå¤©å®¤...</div>';
            
            console.log('å½“å‰ç”¨æˆ·å·²åŠ è½½:', currentUser.username);
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // è®¾ç½®æ»šåŠ¨ç›‘å¬å™¨
            messagesContainer.addEventListener('scroll', function() {
                // å½“æ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘æ—¶ï¼ŒåŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
                if (messagesContainer.scrollTop < 100 && hasMoreMessages && !isLoadingMore) {
                    loadMoreMessages();
                }
            });
            
            // æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', function(snapshot) {
                if (snapshot.val() === true) {
                    console.log('å·²è¿æ¥åˆ°Firebase');
                    
                    registerOnlineUser();
                    listenForOnlineUsers();
                    
                    // é¦–æ¬¡åŠ è½½å†å²æ¶ˆæ¯
                    loadMoreMessages();
                    
                    // å¼€å§‹ç›‘å¬æ–°æ¶ˆæ¯
                    listenForNewMessages();
                } else {
                    console.log('ä¸Firebaseæ–­å¼€è¿æ¥');
                    document.getElementById('userCount').textContent = 'è¿æ¥ä¸­...';
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', function() {
            initializeApp();
            updateSendButtonStatus(); // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
        });

        // é˜²æ­¢åˆ·æ–°ä¸¢å¤±åœ¨çº¿çŠ¶æ€
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                onlineUsersRef.child(currentUser.id).remove();
            }
        });

        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ¶ˆæ¯æ—¶é—´æ˜¾ç¤º
        setInterval(updateMessageTimes, 60000);

        // æ¯ç§’æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        setInterval(updateSendButtonStatus, 1000);

        // å®šæœŸæ¸…ç†æ—§æ¶ˆæ¯
        setInterval(function() {
            messagesRef.limitToLast(100).once('value', function(snapshot) {
                const messages = [];
                snapshot.forEach(function(childSnapshot) {
                    messages.push({
                        key: childSnapshot.key,
                        timestamp: childSnapshot.val().timestamp
                    });
                });
                
                if (messages.length > 100) {
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    const toDelete = messages.slice(0, messages.length - 100);
                    toDelete.forEach(function(msg) {
                        messagesRef.child(msg.key).remove();
                    });
                }
            });
        }, 60000);
    </script>
</body>
</html>
